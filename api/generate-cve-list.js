const fs = require('fs')
const glob = require('glob')
const id = require('./id')

const dataDir = 'api/data/cvelist/'
const outFile = 'api/data/vulnerabilities.ndjson'

glob(dataDir + '**/*.json', (er, files) => {
  files.forEach(fileName => {
    let data = fs.readFileSync(fileName, 'utf8')
    data = JSON.parse(data)
    const jsonData = JSON.stringify(data)

    const index = JSON.stringify({ index: { _id: id() } })
    if (data.CVE_data_meta.STATE !== 'RESERVED') {
      fs.appendFileSync(outFile, index + '\n')
      fs.appendFileSync(outFile, jsonData + '\n')
    }
  })
})
